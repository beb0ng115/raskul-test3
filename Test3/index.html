<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Product</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple transition for step visibility */
        .form-step {
            transition: opacity 0.3s ease-in-out;
        }
        .hidden-step {
            opacity: 0;
            position: absolute;
            pointer-events: none;
        }
        .visible-step {
            opacity: 1;
        }
        /* Style for the progress indicator */
        .step-indicator {
            @apply flex justify-between mb-8;
        }
        .step-indicator > div {
            @apply flex-1 text-center;
        }
        .step-indicator > div > span {
            @apply block text-sm font-medium text-gray-500;
        }
        .step-indicator > div > div {
            @apply w-full h-1 bg-gray-200 mt-1 rounded;
        }
        .step-indicator > div.active > span {
            @apply text-indigo-600 font-semibold;
        }
        .step-indicator > div.active > div {
            @apply bg-indigo-600;
        }
        /* Basic styling for table */
        th, td {
            @apply px-4 py-2 border border-gray-300 text-sm;
        }
        th {
             @apply bg-gray-100 font-medium text-left;
        }
        /* Ensure inputs inside table cells take up space */
        td input, td select {
            @apply w-full p-1 border border-gray-300 rounded;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md">

            <h1 class="text-2xl font-semibold mb-2 text-gray-800">Add New Product</h1>
            <p class="text-gray-600 mb-6 text-sm"><a href="#" class="text-indigo-600 hover:underline">&lt; Back to product listing</a></p>

            <div id="step-indicator" class="step-indicator mb-8">
                <div id="step-indicator-1" class="active">
                    <span>Product Details</span>
                    <div></div>
                </div>
                <div id="step-indicator-2">
                    <span>Inventory</span>
                    <div></div>
                </div>
                <div id="step-indicator-3">
                    <span>Preview & Publish</span>
                    <div></div>
                </div>
            </div>

            <form id="addProductForm">

                <div id="step-1" class="form-step visible-step">
                    <h2 class="text-xl font-medium mb-6 text-gray-700 border-b pb-2">Basic Information</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                            <input type="text" id="productName" name="productName" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="productModel" class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                            <select id="productModel" name="productModel" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                <option value="">Select Models</option>
                                <option value="55">iPhone 11 Pro Max</option>
                                <option value="56">iPhone 12</option>
                                <option value="70">Samsung Galaxy S22</option>
                                </select>
                        </div>
                        <div>
                            <label for="productSlug" class="block text-sm font-medium text-gray-700 mb-1">Slug</label>
                            <input type="text" id="productSlug" name="productSlug" placeholder="auto-generated-slug" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50" readonly>
                            <p class="text-xs text-gray-500 mt-1">URL-friendly identifier (auto-generated or editable)</p>
                        </div>
                        <div>
                            <label for="productCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="productCategory" name="productCategory" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                <option value="">Select Category</option>
                                <option value="10">Smartphones</option>
                                <option value="11">Apple iPhones</option>
                                <option value="12">Samsung Galaxy</option>
                                </select>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="productDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="productDescription" name="productDescription" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Images</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600">
                                    <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                        <span>Upload files</span>
                                        <input id="file-upload" name="file-upload" type="file" class="sr-only" multiple>
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                            </div>
                        </div>
                        </div>

                    <div class="flex justify-end">
                        <button type="button" onclick="goToStep(2)" class="px-6 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Next</button>
                    </div>
                </div>

                <div id="step-2" class="form-step hidden-step">
                    <h2 class="text-xl font-medium mb-6 text-gray-700 border-b pb-2">Sale Information & Inventory</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                         <div>
                            <label for="saleStatus" class="block text-sm font-medium text-gray-700 mb-1">Sale Status</label>
                            <select id="saleStatus" name="saleStatus" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                <option value="active">Active</option>
                                <option value="draft">Draft</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div>
                             <label for="overallStock" class="block text-sm font-medium text-gray-700 mb-1">Overall Stock</label>
                             <input type="number" id="overallStock" name="overallStock" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50" readonly>
                             <p class="text-xs text-gray-500 mt-1">Automatically calculated from variants (for unique items).</p>
                        </div>
                    </div>

                    <h3 class="text-lg font-medium mb-4 text-gray-700">Variations (Individual Phones)</h3>
                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full border-collapse border border-gray-300">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>IMEI</th>
                                    <th>Color</th>
                                    <th>Storage</th>
                                    <th>Year</th>
                                    <th>OS Version</th>
                                    <th>Condition</th>
                                    <th>Price ($)</th>
                                    <th>Available</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="variantsTableBody">
                                </tbody>
                        </table>
                    </div>

                    <button type="button" onclick="addVariantRow()" class="mb-6 px-4 py-2 border border-indigo-600 text-indigo-600 rounded-md hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        + Add Variant (Phone)
                    </button>

                    <div class="flex justify-between">
                        <button type="button" onclick="goToStep(1)" class="px-6 py-2 bg-gray-600 text-white rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Back</button>
                        <button type="button" onclick="goToStep(3)" class="px-6 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Next</button>
                    </div>
                </div>

                <div id="step-3" class="form-step hidden-step">
                    <h2 class="text-xl font-medium mb-6 text-gray-700 border-b pb-2">Preview & Publish</h2>

                    <div id="previewArea" class="space-y-6 mb-6">
                        <h3 class="text-lg font-medium text-gray-800">Basic Information</h3>
                        <div class="text-sm text-gray-700 space-y-2">
                            <p><strong>Name:</strong> <span id="previewName"></span></p>
                            <p><strong>Model:</strong> <span id="previewModel"></span></p>
                            <p><strong>Category:</strong> <span id="previewCategory"></span></p>
                            <p><strong>Slug:</strong> <span id="previewSlug"></span></p>
                            <p><strong>Description:</strong> <span id="previewDescription"></span></p>
                            </div>

                        <h3 class="text-lg font-medium text-gray-800">Sale Information</h3>
                         <div class="text-sm text-gray-700 space-y-2">
                             <p><strong>Sale Status:</strong> <span id="previewSaleStatus"></span></p>
                         </div>

                        <h3 class="text-lg font-medium text-gray-800">Variations</h3>
                        <div id="previewVariantsTableContainer" class="overflow-x-auto">
                            </div>
                    </div>

                    <div class="flex justify-between">
                        <button type="button" onclick="goToStep(2)" class="px-6 py-2 bg-gray-600 text-white rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Back</button>
                        <button type="button" onclick="publishProduct()" class="px-6 py-2 bg-green-600 text-white rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Publish</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 3;

        // --- Navigation ---
        function goToStep(stepNumber) {
            if (stepNumber < 1 || stepNumber > totalSteps) return;

            // Optional: Add validation before proceeding
            if (stepNumber > currentStep && !validateStep(currentStep)) {
                 alert('Please fill out all required fields before proceeding.');
                 return;
            }

            // Update step visibility
            document.getElementById(`step-${currentStep}`).classList.replace('visible-step', 'hidden-step');
            document.getElementById(`step-${stepNumber}`).classList.replace('hidden-step', 'visible-step');

            // Update indicator
            document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');
            document.getElementById(`step-indicator-${stepNumber}`).classList.add('active');

            currentStep = stepNumber;

            // Populate preview if moving to step 3
            if (currentStep === 3) {
                populatePreview();
            }
        }

        // --- Slug Generation (Simple Example) ---
        const productNameInput = document.getElementById('productName');
        const productSlugInput = document.getElementById('productSlug');
        productNameInput.addEventListener('input', () => {
            productSlugInput.value = productNameInput.value
                .toLowerCase()
                .trim()
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/[^\w-]+/g, '') // Remove non-word characters (except hyphen)
                .replace(/--+/g, '-'); // Replace multiple hyphens with single
        });

        // --- Variant Table Management ---
        const variantsTableBody = document.getElementById('variantsTableBody');
        let variantRowCount = 0;

        function addVariantRow() {
            variantRowCount++;
            const newRow = variantsTableBody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" name="variant_sku[]" class="variant-sku" required></td>
                <td><input type="text" name="variant_imei[]" class="variant-imei" required pattern="[0-9]{15}" title="Enter a 15-digit IMEI"></td>
                <td><input type="text" name="variant_color[]" class="variant-color"></td>
                <td><input type="text" name="variant_storage[]" class="variant-storage"></td>
                <td><input type="number" name="variant_year[]" class="variant-year" min="2000" max="${new Date().getFullYear()}"></td>
                <td><input type="text" name="variant_os[]" class="variant-os"></td>
                <td>
                    <select name="variant_condition[]" class="variant-condition">
                        <option value="Excellent">Excellent</option>
                        <option value="Good" selected>Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Parts Only">Parts Only</option>
                    </select>
                </td>
                <td><input type="number" step="0.01" name="variant_price[]" class="variant-price" required min="0"></td>
                <td><input type="number" name="variant_available[]" value="1" class="bg-gray-100 variant-available" readonly></td>
                 <td><button type="button" class="text-red-600 hover:text-red-800 text-sm" onclick="removeVariantRow(this)">Remove</button></td>
            `;
             updateOverallStock();
        }

        function removeVariantRow(button) {
            const row = button.closest('tr');
            if (row) {
                row.remove();
                updateOverallStock();
            }
        }

         function updateOverallStock() {
            const variantRows = variantsTableBody.querySelectorAll('tr');
            document.getElementById('overallStock').value = variantRows.length;
        }

        // --- Validation (Basic Example) ---
        function validateStep(step) {
             if (step === 1) {
                 // Check required fields in step 1
                 const name = document.getElementById('productName').value.trim();
                 const model = document.getElementById('productModel').value;
                 // Add more checks as needed (category, description?)
                 return name !== '' && model !== '';
             } else if (step === 2) {
                 // Check if at least one variant exists and required variant fields are filled
                 const variantRows = variantsTableBody.querySelectorAll('tr');
                 if (variantRows.length === 0) {
                     alert("Please add at least one variant (phone).");
                     return false;
                 }
                 for (const row of variantRows) {
                     const sku = row.querySelector('.variant-sku').value.trim();
                     const imei = row.querySelector('.variant-imei').value.trim();
                     const price = row.querySelector('.variant-price').value;
                     if (sku === '' || imei === '' || price === '') {
                         alert("Please fill in required fields (SKU, IMEI, Price) for all variants.");
                         return false;
                     }
                     // Basic IMEI format check (15 digits) - more robust validation recommended
                     if (!/^\d{15}$/.test(imei)) {
                          alert(`Invalid IMEI format for SKU ${sku}. Must be 15 digits.`);
                          return false;
                     }
                 }
                 return true; // All variants seem okay
             }
             return true; // No validation for other steps in this example
        }


        // --- Preview Population ---
        function populatePreview() {
            // Basic Info
            document.getElementById('previewName').textContent = document.getElementById('productName').value;
            const modelSelect = document.getElementById('productModel');
            document.getElementById('previewModel').textContent = modelSelect.options[modelSelect.selectedIndex]?.text || 'N/A';
            const categorySelect = document.getElementById('productCategory');
            document.getElementById('previewCategory').textContent = categorySelect.options[categorySelect.selectedIndex]?.text || 'N/A';
            document.getElementById('previewSlug').textContent = document.getElementById('productSlug').value;
            document.getElementById('previewDescription').textContent = document.getElementById('productDescription').value;

            // Sale Info
            const statusSelect = document.getElementById('saleStatus');
             document.getElementById('previewSaleStatus').textContent = statusSelect.options[statusSelect.selectedIndex]?.text || 'N/A';

            // Variants Table
            const previewTableContainer = document.getElementById('previewVariantsTableContainer');
            const variantRows = variantsTableBody.querySelectorAll('tr');
            let tableHTML = `<table class="min-w-full border-collapse border border-gray-300 text-sm">
                                <thead>
                                    <tr>
                                        <th>SKU</th><th>IMEI</th><th>Color</th><th>Storage</th><th>Year</th><th>OS</th><th>Condition</th><th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            if (variantRows.length === 0) {
                 tableHTML += `<tr><td colspan="8" class="text-center text-gray-500 py-4">No variants added.</td></tr>`;
            } else {
                variantRows.forEach(row => {
                    tableHTML += `<tr>
                                    <td>${row.querySelector('.variant-sku')?.value || ''}</td>
                                    <td>${row.querySelector('.variant-imei')?.value || ''}</td>
                                    <td>${row.querySelector('.variant-color')?.value || ''}</td>
                                    <td>${row.querySelector('.variant-storage')?.value || ''}</td>
                                    <td>${row.querySelector('.variant-year')?.value || ''}</td>
                                    <td>${row.querySelector('.variant-os')?.value || ''}</td>
                                    <td>${row.querySelector('.variant-condition')?.value || ''}</td>
                                    <td>$${parseFloat(row.querySelector('.variant-price')?.value || 0).toFixed(2)}</td>
                                  </tr>`;
                });
            }
            tableHTML += `</tbody></table>`;
            previewTableContainer.innerHTML = tableHTML;
        }

        // --- Publish Action ---
        function publishProduct() {
            if (!validateStep(1) || !validateStep(2)) {
                 alert('Please review all steps and fill required fields.');
                 goToStep(1); // Go back to first step with issues potentially
                 return;
            }

            // 1. Collect Product Data
            const productData = {
                name: document.getElementById('productName').value,
                model_id: document.getElementById('productModel').value,
                category_id: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value,
                slug: document.getElementById('productSlug').value,
                // image data would be handled separately
            };

            // 2. Collect Variants Data
            const variantsData = [];
            const variantRows = variantsTableBody.querySelectorAll('tr');
            variantRows.forEach(row => {
                const variant = {
                    sku: row.querySelector('.variant-sku')?.value,
                    price: parseFloat(row.querySelector('.variant-price')?.value || 0),
                    imei: row.querySelector('.variant-imei')?.value,
                    options: [
                        // Map input fields to the option structure expected by the backend
                        { option_name: "Color", value: row.querySelector('.variant-color')?.value || '' },
                        { option_name: "Storage", value: row.querySelector('.variant-storage')?.value || '' },
                        { option_name: "Year Manufactured", value: row.querySelector('.variant-year')?.value || '' },
                        { option_name: "OS Version", value: row.querySelector('.variant-os')?.value || '' },
                        { option_name: "Condition", value: row.querySelector('.variant-condition')?.value || '' },
                         // Note: IMEI is both an option and a direct field in this example backend
                        { option_name: "IMEI", value: row.querySelector('.variant-imei')?.value || '' }
                    ].filter(opt => opt.value !== '') // Optionally filter out empty values
                };
                variantsData.push(variant);
            });

            // 3. Construct Final Payload
            const payload = {
                product: productData,
                variants: variantsData
            };

            console.log("--- Publishing Product ---");
            console.log(JSON.stringify(payload, null, 2)); // Log data to console

            // 4. Send to Backend (using Fetch API example)
            /*
            fetch('/api/products', { // Use the correct endpoint from your Node.js code
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            })
            .then(response => {
                if (!response.ok) {
                    // If response is not OK, try to parse error JSON
                    return response.json().then(err => { throw new Error(err.message || `HTTP error! status: ${response.status}`) });
                }
                return response.json(); // Parse success JSON
            })
            .then(data => {
                console.log('Success:', data);
                alert('Product published successfully!');
                // Optionally redirect or clear the form
                // window.location.href = '/product-listing'; // Example redirect
            })
            .catch((error) => {
                console.error('Error:', error);
                alert(`Failed to publish product: ${error.message}`);
            });
            */

             alert('Product data logged to console. See commented fetch() code for actual API call.'); // Placeholder alert
        }

        // Initialize first step
        document.addEventListener('DOMContentLoaded', () => {
            goToStep(1); // Ensure only step 1 is visible initially
             updateOverallStock(); // Initialize stock display
        });

    </script>

</body>
</html>
```

**Explanation:**

1.  **HTML Structure:** Sets up the basic page with Tailwind CSS. It includes divs for each step (`step-1`, `step-2`, `step-3`) and a step indicator at the top.
2.  **Tailwind CSS:** Used extensively for layout (grid, flex), spacing (p-, m-, gap-), borders, shadows, rounded corners, and basic styling of form elements and buttons.
3.  **JavaScript for Steps:**
    * `goToStep(stepNumber)`: Hides the current step and shows the requested step. It also updates the visual step indicator. Basic validation is called before moving forward.
    * `validateStep(step)`: A placeholder for validation logic. Currently checks for basic required fields in steps 1 and 2.
    * `currentStep`: Keeps track of the active step.
4.  **Step Content:**
    * **Step 1:** Contains standard form inputs for product details. A simple slug generation based on the name is included.
    * **Step 2:** Includes inputs for sales status and a read-only overall stock field. The core is the `variantsTableBody`.
    * **Step 3:** Contains `<span>` elements (`previewName`, `previewModel`, etc.) that will be populated by JavaScript in the `populatePreview` function.
5.  **Variant Table Logic:**
    * `addVariantRow()`: Creates a new table row with input fields for all necessary variant details (SKU, IMEI, Color, Storage, Year, OS, Condition, Price). Sets 'Available' to 1 and read-only. Adds a "Remove" button.
    * `removeVariantRow(button)`: Removes the table row containing the clicked button.
    * `updateOverallStock()`: Updates the read-only "Overall Stock" field based on the number of variant rows.
6.  **Preview Logic:**
    * `populatePreview()`: Reads the values from the form fields in Steps 1 and 2 and displays them in the Step 3 preview area. It dynamically generates a preview table for the variants.
7.  **Publish Logic:**
    * `publishProduct()`:
        * Performs final validation.
        * Collects data from the form fields (product details and all variant rows).
        * Structures the data into the JSON format expected by your Node.js backend (`product` object and `variants` array).
        * Logs the final JSON payload to the browser console.
        * Includes a commented-out `fetch()` example showing how you would send this data to your `/api/products` endpoint.

This code provides a functional front-end structure that matches your mockups and includes the necessary fields for adding used smartphones. You can adapt and enhance the styling, validation, and backend integration furth